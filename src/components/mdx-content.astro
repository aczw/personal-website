---
import type { MarkdownHeading } from "astro";
import type { AstroComponentFactory } from "astro/runtime/server/index.js";

import Anchor from "@/components/mdx/anchor.astro";
import Aside from "@/components/mdx/aside.astro";
import H2 from "@/components/mdx/h2.astro";
import H3 from "@/components/mdx/h3.astro";
import H4 from "@/components/mdx/h4.astro";

import TableOfContents from "@/components/table-of-contents.astro";

interface Props {
  content: AstroComponentFactory;
  headings: MarkdownHeading[];
}

const { content: Content, headings } = Astro.props;
---

<Fragment>
  <article aria-label="Write-up" class="mdx">
    <div
      role="none"
      class="md:col-span-2 md:col-start-2 md:grid md:grid-cols-subgrid xl:col-start-4"
    >
      <Content
        components={{
          h2: H2,
          h3: H3,
          h4: H4,
          blockquote: Aside,
          a: Anchor,
        }}
      />
    </div>

    <TableOfContents
      headings={headings}
      class="col-start-4 ml-pad-2 hidden md:block lg:ml-pad-4 xl:col-start-7"
    />
  </article>

  <dialog
    class="fixed top-1/2 left-1/2 mb-0 w-full max-w-[calc(1100px+2*var(--spacing-pad))] transform-[translate(-50%,-50%)] bg-transparent outline-0 backdrop:bg-sweater-10/85 not-dark:backdrop:bg-sweater-1/85"
  >
    <div class="p-pad">
      <img
        loading="eager"
        class="mx-auto max-h-[80vh] cursor-zoom-out rounded-xl select-none"
      />
    </div>
  </dialog>
</Fragment>

<script>
  const dialogElt = document.querySelector("dialog");
  const dialogImgElt =
    document.querySelector<HTMLImageElement>("dialog > div > img");

  /**
   * @see https://cassidoo.co/post/html-dialog-on-image-click
   */
  function makeMediaZoomable() {
    // Only activate on desktop
    if (!window.matchMedia("(hover: hover)").matches) return;

    if (!dialogElt || !dialogImgElt) {
      console.error("Dialog and/or dialog image not found!");
      return;
    }

    // Add a click listener to images that are zoomable (true by default)
    document.querySelectorAll(".mdx img:not([data-no-zoom])").forEach((elt) => {
      elt.addEventListener("click", () => {
        const imgElt = elt as HTMLImageElement;

        dialogImgElt.src = imgElt.src;
        dialogImgElt.srcset = imgElt.srcset;
        dialogImgElt.alt = imgElt.alt;
        dialogElt.showModal();
      });
    });

    document.addEventListener("keydown", (ev) => {
      if (ev.key === "Escape") {
        dialogImgElt.src = "";
        dialogImgElt.srcset = "";
        dialogImgElt.alt = "";
      }
    });

    dialogElt.addEventListener("click", () => {
      dialogElt.close();
      dialogImgElt.src = "";
      dialogImgElt.srcset = "";
      dialogImgElt.alt = "";
    });
  }

  makeMediaZoomable();
</script>
