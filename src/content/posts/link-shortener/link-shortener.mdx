---
title: Making my own link shortener with Astro DB
blurb: To easily share my Spotify, I like to use link shortener services. I got tired of how they always stopped working, so like any other sane person, I wrote my own.
tags:
  - Astro
  - Astro DB
cover:
  img: ./link-shortener.png
  alt: TODO

published: false
slug: link-shortener
---

To see it in action, visit my Spotify profile at [go.czw.sh/spotify](https://go.czw.sh/spotify).

## Background

I like sharing music. To follow my friends and ~~stalk~~ see what they're listening to, I often send them my Spotify profile. However, ever since they removed [custom usernames](https://community.spotify.com/t5/Accounts/Spotify-Username-Completely-Random/td-p/4392395#), I've been stuck with the very memorable username of `zhwq0rxdn060sgar22e07u193`, and searching for my display name is pretty much impossible.

To get around that, I use link shorteners, but I've found that they're very unreliable, and often shut down/stop working. With the recent release of Astro Studio and [Astro DB](https://astro.build/db/), I thought this was the perfect chance to test it out... and solve my issue once and for all.

> I'm also not insane, by the way; a simple search for ["spotify link shortener"](https://duckduckgo.com/?q=spotify+link+shortener) returns a number of _dedicated websites_ for doing this. Notably, Dub.co has their own [Spotify tool](https://dub.co/tools/spotify-link-shortener), which I used up to this point.

## Setting up Astro Studio and Astro DB

This was easy enough to do.

## Redirecting

This project only has two routes: a main `index.astro` for the root, and a `[...slug].astro` that captures everything else. The former is for creating new links, and the latter is where we do the redirecting.

Astro has a built-in way of modifying the response returned by the server. In particular, I set the status code to 301 and set the `Location` header to the original URL.

```astro
---
Astro.response.status = 301;
Astro.response.headers.set("Location", original);
---
```

I spent a bit trying to figure out which [redirect status code](https://developer.mozilla.org/en-US/docs/Web/HTTP/Redirections) I should be responding with. Doing a bit of research revealed that most link shorteners use either 301 or 302. I settled on 301 because

- once a short URL is generated, it will forever be associated with the original URL. "Moved permanently" perfectly captures this idea.

- the class of temporary redirections doesn't fit our motives here. Temporary implies that some day, a user will be able to access the page at our short URL. This will never happen; in fact, there is literally no HTML to render. More on this below.

- search engines and crawlers should never show the short URL. All information should be passed to the original URL.

> 308 also seems to be a valid alternative to 301, but from what I learned it mostly provides more consistency with non-`GET` operations. We only use `GET`, so 301 works fine.

One interesting thing here is that no HTML exists for the `/[...slug]` route. The only code in this file is in the Astro frontmatter, which only gets executed on the server. If no short URL exists in the database, then I simply redirect to the home page.
