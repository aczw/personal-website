---
import { getCollection } from "astro:content";

import {
  BoxesIcon,
  InfoIcon,
  SquareArrowRightIcon,
  SquareMousePointerIcon,
  SquareDashedMousePointerIcon,
  FeatherIcon,
  ToolCaseIcon,
} from "@lucide/astro";

import ProjectCover from "@/components/project-cover.astro";
import {
  DISABLED_PROJECTS,
  WIDE_PROJECTS,
  ICON_SIZE,
} from "@/scripts/constants";
import MainLayout from "@/layouts/main-layout.astro";
import TechList from "@/components/tech-list.astro";
import ContentDate from "@/components/content-date.astro";
import GridSection from "@/components/grid-section.astro";
import BaseLayout from "@/layouts/base-layout.astro";
import MusicIndicator from "@/components/music-indicator.astro";
import Eye from "@/components/eye.astro";

const withVideos: string[] = [
  "cuda-path-tracer",
  "pbr-renderer",
  "cuda-boids",
  "catanks",
];

const projects = (await getCollection("projects"))
  .filter((project) => !DISABLED_PROJECTS.includes(project.id))
  .sort((a, b) => a.data.order - b.data.order);

const totalCells = projects.reduce(
  (sum, { id }) => (WIDE_PROJECTS.includes(id) ? sum + 2 : sum + 1),
  0,
);
---

<BaseLayout
  meta={{
    kind: "route",
    title: "Projects",
    description:
      "Projects mostly revolving around computer graphics, game development, and some art on the side.",
    ogImageParams: "Graphics programming, games, and sometimes art.",
  }}
>
  <header class="mx-auto max-w-[525px] pt-12 pb-12">
    <!-- <div class="grid grid-cols-2 items-end">
      <h1 class="cursor-default space-y-0.5">
        <Eye
          class="peer size-6 fill-sweater-5 transition-[rotate_fill] not-dark:fill-sweater-6 hover:-rotate-13 hover:fill-sweater-4 not-dark:hover:fill-sweater-7"
        />

        <span
          class="text-[1.75rem] font-bold text-sweater-5 transition-colors not-dark:text-sweater-6 peer-hover:text-sweater-4 not-dark:peer-hover:text-sweater-7"
        >
          Charles Wang
        </span>
      </h1>

      <nav
        class="grid grid-cols-2 bordered text-lg leading-none font-bold *:flex *:items-center *:justify-between *:gap-pad *:p-pad *:text-link-primary *:transition-colors *:hover:bg-line *:hover:text-link-primary-hover"
      >
        <a
          href="/projects"
          class="border-r-(length:--border-w) border-b-(length:--border-w) border-style"
        >
          Portfolio <ToolCaseIcon size={ICON_SIZE} class="stroke-icon" />
        </a>
        <a href="/posts" class="border-b-(length:--border-w) border-style">
          Writing <FeatherIcon size={ICON_SIZE} class="stroke-icon" />
        </a>
        <a href="/archive" class="border-r-(length:--border-w) border-style">
          Archive <BoxesIcon size={ICON_SIZE} class="stroke-icon" />
        </a>
        <a href="/about">
          About <MusicIndicator server:defer>
            <InfoIcon slot="fallback" size={ICON_SIZE} class="stroke-icon" />
          </MusicIndicator>
        </a>
      </nav>
    </div> -->

    <div class="mb-6 font-bold">
      <p class="mb-1 flex items-center gap-1.5 text-2xl">
        <a
          title="Home"
          href="/"
          class="group transition-transform hover:-rotate-13"
        >
          <Eye
            class="size-4.75 fill-link-secondary transition-colors group-hover:fill-link-secondary-hover"
          />
        </a>
        <span class="cursor-default leading-none text-sweater-7">/</span>
      </p>
      <h1
        class="text-4xl leading-none text-link-primary hover:text-link-secondary-hover"
      >
        Portfolio
      </h1>
    </div>

    <!-- <div class="flex flex-col gap-pad-2">
      <p>
        However, AABBs are not enough. For models with many triangles, they
        cannot help because if the intersection is successful, we’ll need to
        iterate through the entire triangle list. Is there some way of
        addressing this?
      </p>
      <p>
        BVHs work on the following principle: if the ray has intersected with
        some bounding box, then anything outside of that box does not need to be
        checked anymore, and can immediately be discarded.
      </p>
      <p>
        For instance, what if we split our model into two different AABBs, let’s
        say at the midpoint of the model? If the ray intersected with one AABB,
        then we know every triangle in the other AABB, aka the other half of the
        model, can be safely ignored.
      </p>
      <p>
        That’s the idea. Of course, having never built one before I needed to do
        some research. My implementation was primarily guided by the following
        two resources:
      </p>
    </div> -->
  </header>

  <main class="mr-auto ml-[calc(var(--spacing)*20+350px)] max-w-[700px]">
    <div class="grid grid-cols-1 bordered 560:grid-cols-2">
      {
        projects.map(
          (
            {
              id,
              data: {
                name,
                blurb,
                metadata: { tech, date },
                cover,
              },
            },
            index,
          ) => {
            const numElapsedCells = projects.reduce(
              (sum, { id }, projectInCategoryIndex) => {
                if (projectInCategoryIndex > index) {
                  return sum;
                }

                if (WIDE_PROJECTS.includes(id)) {
                  return sum + 2;
                } else {
                  return sum + 1;
                }
              },
              0,
            );

            return WIDE_PROJECTS.includes(id) ?
                <div
                  class:list={[
                    "480:hover:bg-line-dark col-span-1 border-style p-pad transition-colors hover:bg-sweater-9/50 not-dark:hover:bg-sweater-2/50 480:p-0 560:col-span-2",
                    index < projects.length - 1 ?
                      "border-b-(length:--border-w)"
                    : null,
                  ]}
                >
                  <a
                    href={`/projects/${id}`}
                    class="group grid grid-cols-1 480:grid-cols-2"
                  >
                    <div class="border-style 480:border-r-(length:--border-w) 480:p-pad">
                      <ProjectCover
                        id={id}
                        cover={cover}
                        useVideo={
                          withVideos.includes(id) ? { small: true } : null
                        }
                        class="overflow-hidden rounded-t-lg 480:rounded-b-lg"
                      />
                    </div>

                    <div class="*: flex flex-col *:border-style normal:grid normal:grid-cols-1 normal:grid-rows-4">
                      <div class="bg-sweater-9 px-pad pt-pad transition-colors not-dark:bg-sweater-2 group-hover:bg-sweater-8 not-dark:group-hover:bg-sweater-3 480:space-y-1 480:border-b-(length:--border-w) 480:bg-transparent 480:pb-pad 480:group-hover:bg-transparent 560:border-b-0 normal:row-span-2 sm:border-b-(length:--border-w)">
                        <h3 class="leading-tight font-bold text-link-primary transition-colors group-hover:text-link-primary-hover 480:text-lg">
                          {name}
                        </h3>
                        <p class="hidden 560:block">{blurb}</p>
                      </div>

                      <div class="hidden border-b-(length:--border-w) p-pad normal:block">
                        <p class="font-bold text-sweater-3/85 transition-colors not-dark:text-sweater-7/85 group-hover:text-link-primary">
                          Tech used
                        </p>

                        <TechList tech={tech} class="text-subtitle" />
                      </div>

                      <div class="hidden p-pad normal:block">
                        <p class="font-bold text-sweater-3/85 transition-colors not-dark:text-sweater-7/85 group-hover:text-link-primary">
                          Date
                        </p>
                        <ContentDate date={date} class="text-subtitle" />
                      </div>

                      <div class="rounded-b-lg bg-sweater-9 px-pad pb-pad transition-colors not-dark:bg-sweater-2 group-hover:bg-sweater-8 not-dark:group-hover:bg-sweater-3 480:bg-transparent 480:pt-pad 480:group-hover:bg-transparent 560:hidden normal:hidden! sm:block">
                        <TechList
                          tech={tech}
                          class="text-link-secondary 480:text-subtitle"
                        />

                        <ContentDate
                          date={date}
                          class="hidden text-subtitle 480:block"
                        />
                      </div>
                    </div>
                  </a>
                </div>
              : <div
                  class:list={[
                    "480:hover:bg-line-dark border-style p-pad transition-colors hover:bg-sweater-9/50 not-dark:hover:bg-sweater-2/50 480:p-0 560:p-pad 560:hover:bg-sweater-9/50 560:not-dark:hover:bg-sweater-2/50",
                    totalCells - numElapsedCells !== 0 ?
                      "border-b-(length:--border-w)"
                    : null,
                    numElapsedCells % 2 === 1 ?
                      "560:border-r-(length:--border-w)"
                    : null,
                  ]}
                >
                  <a
                    href={`/projects/${id}`}
                    class="group grid grid-cols-1 480:grid-cols-2 560:grid-cols-1"
                  >
                    <div class="border-style 480:border-r-(length:--border-w) 480:p-pad 560:border-r-0 560:p-0">
                      <ProjectCover
                        id={id}
                        cover={cover}
                        useVideo={
                          withVideos.includes(id) ? { small: true } : null
                        }
                        class="overflow-hidden rounded-t-lg 480:rounded-b-lg 560:rounded-b-none"
                      />
                    </div>

                    <div class="rounded-b-lg bg-sweater-9 transition-colors not-dark:bg-sweater-2 group-hover:bg-sweater-8 not-dark:group-hover:bg-sweater-3 480:bg-transparent 480:group-hover:bg-transparent 560:bg-sweater-9 560:not-dark:bg-sweater-2 560:group-hover:bg-sweater-8 560:not-dark:group-hover:bg-sweater-3">
                      <h3 class="border-style px-pad pt-pad leading-tight font-bold text-link-primary transition-colors group-hover:text-link-primary-hover 480:border-b-(length:--border-w) 480:pb-pad 480:text-lg 560:border-b-0 560:pb-0 560:text-base">
                        {name}
                      </h3>

                      <TechList
                        tech={tech}
                        class="px-pad pb-pad text-link-secondary 480:pt-pad 480:pb-0 480:text-subtitle 560:pt-0 560:pb-pad 560:text-link-secondary"
                      />

                      <ContentDate
                        date={date}
                        class="hidden px-pad pb-pad text-subtitle 480:block 560:hidden"
                      />
                    </div>
                  </a>
                </div>;
          },
        )
      }
    </div>
  </main>
</BaseLayout>
